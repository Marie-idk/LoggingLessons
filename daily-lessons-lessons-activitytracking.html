<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Rainbow Daily Log</title>
    
    <!-- Google Fonts: Outfit -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <!-- Custom Styles -->
    <style>
        body, html {
            background-color: #f8fafc;
            font-family: 'Outfit', sans-serif;
            color: #334155;
        }

        /* Modern Card Style */
        .pro-card {
            background: white;
            border-radius: 1rem;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        /* Form Controls */
        .form-input {
            width: 100%;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
            padding: 0.75rem;
            font-size: 0.95rem;
            font-weight: 500;
            color: #334155;
            background: #f8fafc;
        }
        .form-input:focus {
            outline: none;
            border-color: #8b5cf6;
            background: white;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        /* Rainbow Strip */
        .rainbow-strip {
            height: 4px;
            width: 100%;
            background: linear-gradient(90deg, #ef4444, #f97316, #eab308, #22c55e, #3b82f6, #8b5cf6, #ec4899);
        }
    </style>
</head>
<body class="pb-20">

    <!-- Navbar -->
    <nav class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b border-slate-200 mb-8">
        <div class="rainbow-strip"></div>
        <div class="max-w-6xl mx-auto px-6 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 text-white p-2 rounded-lg">
                    <i data-lucide="book-open" class="w-5 h-5"></i>
                </div>
                <h1 class="text-xl font-bold text-slate-800">Gabriel's Log</h1>
            </div>
            
            <div class="flex items-center gap-4">
                <div id="desktop-nav" class="hidden md:flex bg-slate-100 p-1 rounded-lg">
                    <!-- Nav injected via JS -->
                </div>
                <button id="btn-pdf" class="hidden flex items-center gap-2 px-3 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 font-medium text-sm">
                    <i data-lucide="download" class="w-4 h-4"></i> Report
                </button>
            </div>
        </div>
        <!-- Mobile Tabs -->
        <div id="mobile-nav" class="md:hidden flex border-t border-slate-200"></div>
    </nav>

    <!-- Main Grid Layout -->
    <main class="max-w-6xl mx-auto px-6">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
            
            <!-- LEFT PANEL: Editor (Col Span 4) -->
            <div id="editor-panel" class="lg:col-span-4 lg:sticky lg:top-24 space-y-6">
                
                <!-- Date Card -->
                <div class="pro-card p-4 flex items-center justify-between">
                    <button id="prev-date" class="p-2 hover:bg-slate-100 rounded-lg text-slate-500"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
                    <div class="text-center">
                        <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Viewing Date</div>
                        <input type="date" id="date-input" class="text-center font-bold text-lg text-slate-800 bg-transparent border-none focus:ring-0 p-0 cursor-pointer">
                    </div>
                    <button id="next-date" class="p-2 hover:bg-slate-100 rounded-lg text-slate-500"><i data-lucide="chevron-right" class="w-6 h-6"></i></button>
                </div>

                <!-- Form Card -->
                <div class="pro-card p-6 border-indigo-100 ring-4 ring-indigo-50/30">
                    <div class="flex justify-between items-center mb-5 border-b border-indigo-50 pb-3">
                        <h2 class="font-bold text-indigo-700 flex items-center gap-2">
                            <i data-lucide="pen-tool" class="w-5 h-5"></i>
                            <span id="form-title">New Entry</span>
                        </h2>
                        <button id="cancel-edit-btn" class="hidden text-xs font-bold text-red-500 bg-red-50 px-2 py-1 rounded hover:bg-red-100">Cancel</button>
                    </div>

                    <form id="journal-form" class="space-y-4">
                        <!-- Type Switcher -->
                        <div class="grid grid-cols-3 gap-1 bg-slate-100 p-1 rounded-xl">
                             <label class="cursor-pointer">
                                <input type="radio" name="entryType" value="daily" class="peer hidden" checked>
                                <div class="text-center py-2 text-xs font-bold text-slate-500 rounded-lg peer-checked:bg-white peer-checked:text-indigo-600 peer-checked:shadow-sm transition-all">Daily</div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="entryType" value="weekly" class="peer hidden">
                                <div class="text-center py-2 text-xs font-bold text-slate-500 rounded-lg peer-checked:bg-white peer-checked:text-indigo-600 peer-checked:shadow-sm transition-all">Weekly</div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="entryType" value="unit" class="peer hidden">
                                <div class="text-center py-2 text-xs font-bold text-slate-500 rounded-lg peer-checked:bg-white peer-checked:text-indigo-600 peer-checked:shadow-sm transition-all">Unit</div>
                            </label>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs font-bold text-slate-400 uppercase ml-1">Subject</label>
                                <select id="input-subject" class="form-input mt-1">
                                    <option value="Math">Math</option>
                                    <option value="Language Arts">Language Arts</option>
                                    <option value="Science">Science</option>
                                    <option value="History">History</option>
                                    <option value="Geography">Geography</option>
                                    <option value="Art">Art</option>
                                    <option value="Music">Music</option>
                                    <option value="PE">PE</option>
                                    <option value="Reading">Reading</option>
                                    <option value="Technology">Technology</option>
                                    <option value="Life Skills">Life Skills</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-400 uppercase ml-1">Type</label>
                                <input id="input-category" list="category-list" class="form-input mt-1" placeholder="Lesson..." value="Lesson">
                                <datalist id="category-list">
                                    <option value="Worksheet"></option>
                                    <option value="Lesson"></option>
                                    <option value="Project"></option>
                                    <option value="Quiz"></option>
                                    <option value="Reading"></option>
                                </datalist>
                            </div>
                        </div>

                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase ml-1">Unit / Module</label>
                            <input type="text" id="input-unit" class="form-input mt-1" placeholder="e.g. Solar System">
                        </div>

                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase ml-1">Activity Description</label>
                            <textarea id="input-topic" class="form-input mt-1 min-h-[100px] resize-none" placeholder="What was accomplished?" required></textarea>
                        </div>

                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase ml-1">Assignments</label>
                            <input type="text" id="input-assignments" class="form-input mt-1" placeholder="e.g. Page 42 #1-10">
                        </div>

                         <div>
                            <label class="text-xs font-bold text-slate-400 uppercase ml-1">Notes</label>
                            <input type="text" id="input-notes" class="form-input mt-1" placeholder="Observations...">
                        </div>

                        <button type="submit" id="save-btn" class="w-full bg-slate-900 text-white font-bold py-4 rounded-xl hover:bg-slate-800 transition-transform active:scale-95 flex items-center justify-center gap-2 shadow-lg mt-2">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                            <span>Save Entry</span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- RIGHT PANEL: Feed (Col Span 8) -->
            <div id="view-container-wrapper" class="lg:col-span-8">
                 <div id="view-container" class="space-y-6">
                    <div class="flex flex-col items-center justify-center py-20 opacity-50">
                        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-slate-800 mb-4"></div>
                        <p class="font-bold text-slate-500">Loading your data...</p>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        const state = {
            user: null,
            // Separate arrays to avoid overwriting during async fetch
            entriesUser: [],
            entriesPublic: [],
            // Combined view
            entries: [],
            viewMode: 'daily',
            date: new Date().toISOString().split('T')[0],
            loading: true,
            editingId: null
        };

        const { jsPDF } = window.jspdf;

        // Init
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        async function initAuth() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        }
        initAuth();

        // MERGE LOGIC
        function updateCombinedEntries() {
            // Combine both sources
            const all = [...state.entriesUser, ...state.entriesPublic];
            
            // Deduplicate by ID just in case
            const unique = Array.from(new Map(all.map(item => [item.id, item])).values());

            // Sort: Date DESC, then Order ASC
            unique.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                if (dateA > dateB) return -1;
                if (dateA < dateB) return 1;
                return (a.order || 0) - (b.order || 0);
            });

            state.entries = unique;
            state.loading = false;
            renderApp();
            updateExportButton();
        }

        onAuthStateChanged(auth, (user) => {
            state.user = user;
            if (user) {
                // 1. Listen to PRIVATE (Old) Data
                // This ensures anything you saved before I switched to 'public' is retrieved
                const privateRef = collection(db, 'artifacts', appId, 'users', user.uid, 'daily_journal');
                onSnapshot(privateRef, (snapshot) => {
                    state.entriesUser = snapshot.docs.map(d => ({ id: d.id, ...d.data(), _source: 'private' }));
                    updateCombinedEntries();
                }, (err) => console.error("Private fetch err", err));

                // 2. Listen to PUBLIC (New) Data
                // This ensures persistent data moving forward
                const publicRef = collection(db, 'artifacts', appId, 'public', 'data', 'daily_journal');
                onSnapshot(publicRef, (snapshot) => {
                    state.entriesPublic = snapshot.docs.map(d => ({ id: d.id, ...d.data(), _source: 'public' }));
                    updateCombinedEntries();
                }, (err) => console.error("Public fetch err", err));

            } else {
                state.loading = false;
                renderApp();
            }
        });

        // Styles
        const getSubjectConfig = (subj) => {
            const config = {
                'Math': 'bg-blue-100 text-blue-700 border-blue-200',
                'Science': 'bg-emerald-100 text-emerald-700 border-emerald-200',
                'Language Arts': 'bg-pink-100 text-pink-700 border-pink-200',
                'History': 'bg-amber-100 text-amber-700 border-amber-200',
                'Reading': 'bg-teal-100 text-teal-700 border-teal-200',
                'Art': 'bg-purple-100 text-purple-700 border-purple-200'
            };
            return config[subj] || 'bg-slate-100 text-slate-700 border-slate-200';
        };

        // Date & View
        document.getElementById('prev-date').addEventListener('click', () => changeDate(-1));
        document.getElementById('next-date').addEventListener('click', () => changeDate(1));
        const dateInput = document.getElementById('date-input');
        dateInput.value = state.date;
        dateInput.addEventListener('change', (e) => { state.date = e.target.value; renderApp(); });

        function changeDate(days) {
            const d = new Date(state.date);
            d.setDate(d.getDate() + days);
            state.date = d.toISOString().split('T')[0];
            dateInput.value = state.date;
            renderApp();
        }

        window.setView = (mode) => {
            state.viewMode = mode;
            renderApp();
        };

        // Form Submit
        document.getElementById('journal-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!state.user) return;

            const data = {
                type: document.querySelector('input[name="entryType"]:checked').value,
                date: state.date,
                subject: document.getElementById('input-subject').value,
                category: document.getElementById('input-category').value,
                unit: document.getElementById('input-unit').value,
                topic: document.getElementById('input-topic').value,
                assignments: document.getElementById('input-assignments').value,
                notes: document.getElementById('input-notes').value,
                updatedAt: serverTimestamp()
            };

            try {
                // ALWAYS save to public for robustness, even if editing
                // Note: If we edit a 'private' doc, this might create a duplicate in public or fail if ID doesn't exist in public. 
                // To keep it simple and safe: We will use the ID. If it was private, we effectively "migrating" it to public if we save it here.
                // But `setDoc` with the old ID to the public collection is safest.
                
                const collectionName = 'daily_journal'; // simplified variable

                if(state.editingId) {
                    // Check if the editing ID is in private or public entries to target correctly?
                    // actually, let's just save to PUBLIC. If it was private, we are moving it to public.
                    // This prevents data loss.
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', collectionName, state.editingId), data)
                        .catch(async () => {
                            // If update fails (doc might not exist in public yet), use setDoc to create it
                             const { setDoc } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js');
                             await setDoc(doc(db, 'artifacts', appId, 'public', 'data', collectionName, state.editingId), data);
                             // If it was in private, we might want to delete it there to avoid dupes, but let's be safe and keep it for now.
                        });

                    state.editingId = null;
                    document.getElementById('form-title').innerText = "New Entry";
                    document.getElementById('save-btn').innerHTML = `<i data-lucide="plus" class="w-5 h-5"></i><span>Save Entry</span>`;
                } else {
                    data.createdAt = serverTimestamp();
                    data.order = Date.now();
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', collectionName), data);
                }
                
                // Clear inputs
                document.getElementById('input-topic').value = '';
                document.getElementById('input-assignments').value = '';
                document.getElementById('input-notes').value = '';
                document.getElementById('cancel-edit-btn').classList.add('hidden');

            } catch(err) {
                console.error(err);
                alert("Error: " + err.message);
            }
        });

        // Edit / Delete
        window.editEntry = (id) => {
            const entry = state.entries.find(e => e.id === id);
            if(!entry) return;
            state.editingId = id;
            
            // Switch to Daily view to see form
            if (state.viewMode === 'all') {
                state.viewMode = 'daily';
            }

            state.date = entry.date;
            dateInput.value = entry.date;
            
            document.querySelector(`input[value="${entry.type||'daily'}"]`).checked = true;
            document.getElementById('input-subject').value = entry.subject;
            document.getElementById('input-category').value = entry.category;
            document.getElementById('input-unit').value = entry.unit;
            document.getElementById('input-topic').value = entry.topic;
            document.getElementById('input-assignments').value = entry.assignments;
            document.getElementById('input-notes').value = entry.notes;

            document.getElementById('form-title').innerText = "Editing Entry";
            document.getElementById('save-btn').innerHTML = `<span>Update Entry</span>`;
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
            
            // Scroll top
            window.scrollTo({ top: 0, behavior: 'smooth' });
            renderApp();
        };

        document.getElementById('cancel-edit-btn').addEventListener('click', () => {
            state.editingId = null;
            document.getElementById('input-topic').value = '';
            document.getElementById('form-title').innerText = "New Entry";
            document.getElementById('save-btn').innerHTML = `<i data-lucide="plus" class="w-5 h-5"></i><span>Save Entry</span>`;
            document.getElementById('cancel-edit-btn').classList.add('hidden');
        });

        window.deleteEntry = async (id) => {
            if(confirm("Delete this entry?")) {
                // Try deleting from public
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'daily_journal', id)).catch(()=>{});
                // Try deleting from private (if it exists there)
                if(state.user) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'daily_journal', id)).catch(()=>{});
                }
            }
        };

        // Export
        const btnPdf = document.getElementById('btn-pdf');
        function updateExportButton() {
            btnPdf.classList.toggle('hidden', state.entries.length === 0);
        }
        btnPdf.addEventListener('click', () => {
            const doc = new jsPDF();
            doc.text(`Homeschool Log: Gabriel Mendoza`, 14, 20);
            const data = (state.viewMode === 'daily' ? state.entries.filter(e => e.date === state.date) : state.entries).map(e => [
                e.date, e.subject, e.category, e.topic, e.assignments||'-', e.notes||'-'
            ]);
            doc.autoTable({ startY: 30, head: [['Date', 'Subject', 'Type', 'Topic', 'Assign', 'Notes']], body: data });
            doc.save('Gabriel_Log.pdf');
        });

        // Render
        function renderApp() {
            // Render Nav
            const nav = document.getElementById('desktop-nav');
            const mobileNav = document.getElementById('mobile-nav');
            const modes = [
                { id: 'daily', label: 'Daily', icon: 'layout-grid' },
                { id: 'weekly', label: 'Weekly', icon: 'calendar' },
                { id: 'unit', label: 'Unit', icon: 'folder' },
                { id: 'all', label: 'History', icon: 'history' }
            ];

            nav.innerHTML = modes.map(m => `
                <button onclick="setView('${m.id}')" class="flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-bold transition-all ${state.viewMode === m.id ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}">
                    <i data-lucide="${m.icon}" class="w-4 h-4"></i> ${m.label}
                </button>
            `).join('');

            mobileNav.innerHTML = modes.map(m => `
                <button onclick="setView('${m.id}')" class="flex-1 py-3 text-xs font-bold uppercase tracking-wide border-b-2 ${state.viewMode === m.id ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-slate-400'}">${m.label}</button>
            `).join('');

            // Layout Logic
            const editorPanel = document.getElementById('editor-panel');
            const viewWrapper = document.getElementById('view-container-wrapper');
            
            // If History, hide editor and full width feed
            if (state.viewMode === 'all') {
                editorPanel.classList.add('hidden');
                viewWrapper.classList.remove('lg:col-span-8');
                viewWrapper.classList.add('lg:col-span-12');
            } else {
                editorPanel.classList.remove('hidden');
                viewWrapper.classList.add('lg:col-span-8');
                viewWrapper.classList.remove('lg:col-span-12');
            }

            // Feed Content
            const container = document.getElementById('view-container');
            if(state.loading) return;

            let filtered = [];
            if(state.viewMode === 'daily') {
                filtered = state.entries.filter(e => e.date === state.date && (!e.type || e.type === 'daily'));
            } else if (state.viewMode === 'weekly') {
                filtered = state.entries.filter(e => e.type === 'weekly');
            } else if (state.viewMode === 'unit') {
                filtered = state.entries.filter(e => e.type === 'unit');
            } else {
                filtered = state.entries;
            }

            if(filtered.length === 0) {
                container.innerHTML = `
                    <div class="pro-card p-12 text-center border-dashed border-2 border-slate-200 shadow-none">
                        <div class="text-slate-300 mb-2"><i data-lucide="clipboard-list" class="w-12 h-12 mx-auto"></i></div>
                        <h3 class="text-slate-600 font-bold">No entries found</h3>
                        <p class="text-slate-400 text-sm">Use the form on the left to add one.</p>
                    </div>
                `;
            } else {
                container.innerHTML = filtered.map(entry => {
                    const style = getSubjectConfig(entry.subject);
                    const dateTag = state.viewMode === 'all' ? `<div class="text-xs font-bold text-slate-400 uppercase mb-1">${entry.date}</div>` : '';
                    return `
                        <div class="pro-card p-5 group relative transition-transform hover:-translate-y-0.5">
                            <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity flex gap-2">
                                <button onclick="editEntry('${entry.id}')" class="text-slate-300 hover:text-indigo-600"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                                <button onclick="deleteEntry('${entry.id}')" class="text-slate-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                            
                            ${dateTag}

                            <div class="flex items-center gap-2 mb-2">
                                <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider border ${style}">
                                    ${entry.subject}
                                </span>
                                <span class="text-xs font-bold text-slate-500 uppercase tracking-wide">
                                    ${entry.category || 'Activity'}
                                </span>
                            </div>

                            <h3 class="text-lg font-bold text-slate-800 leading-snug mb-3">
                                ${entry.unit ? `<span class="text-slate-500 font-medium">${entry.unit}:</span> ` : ''}
                                ${entry.topic}
                            </h3>

                             ${(entry.assignments || entry.notes) ? `
                                <div class="space-y-2 pt-3 border-t border-slate-50">
                                    ${entry.assignments ? `
                                        <div class="flex items-start gap-3">
                                            <div class="mt-0.5 text-amber-500 shrink-0"><i data-lucide="check-square" class="w-4 h-4"></i></div>
                                            <div>
                                                <div class="text-[10px] font-bold text-slate-400 uppercase">Assignment</div>
                                                <div class="text-sm font-medium text-slate-700">${entry.assignments}</div>
                                            </div>
                                        </div>
                                    ` : ''}
                                    ${entry.notes ? `
                                        <div class="flex items-start gap-3">
                                            <div class="mt-0.5 text-slate-400 shrink-0"><i data-lucide="message-square" class="w-4 h-4"></i></div>
                                            <div>
                                                <div class="text-[10px] font-bold text-slate-400 uppercase">Notes</div>
                                                <div class="text-sm font-medium text-slate-600 italic">"${entry.notes}"</div>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            }
            lucide.createIcons();
        }
    </script>
</body>
</html>
