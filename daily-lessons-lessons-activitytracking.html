<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Rainbow Daily Log</title>
    
    <!-- Google Fonts: Outfit for a clean, modern, professional look -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <!-- Custom Styles -->
    <style>
        :root {
            /* Mobile Tuning Tokens */
            --container-padding: 1rem;
            --card-radius: 1rem;
            --btn-height: 48px; /* Touch target size */
        }

        body, html {
            background-color: #f8fafc; /* Clean slate background */
            font-family: 'Outfit', sans-serif;
            color: #334155;
            -webkit-font-smoothing: antialiased;
        }

        /* Modern Card Style */
        .pro-card {
            background: white;
            border-radius: 1.25rem;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
            transition: all 0.2s ease;
        }

        /* Rainbow Accent Bar (Subtle) */
        .rainbow-strip {
            height: 4px;
            width: 100%;
            background: linear-gradient(90deg, #ef4444, #f97316, #eab308, #22c55e, #3b82f6, #8b5cf6, #ec4899);
        }

        /* Form Controls */
        .form-input {
            width: 100%;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
            font-weight: 500;
            color: #334155;
            transition: all 0.2s;
            background: #f8fafc;
        }
        .form-input:focus {
            outline: none;
            border-color: #8b5cf6;
            background: white;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        /* Dragging State */
        .dragging {
            opacity: 0.5;
            border: 2px dashed #8b5cf6;
            background: #f5f3ff;
            transform: scale(0.98);
        }
        .drag-over {
            border-top: 3px solid #8b5cf6;
            margin-top: 0.5rem;
        }

        /* Responsive utilities */
        @media (max-width: 768px) {
            .mobile-stack {
                flex-direction: column;
            }
        }
    </style>
</head>
<body class="pb-20">

    <!-- Top Navigation -->
    <nav class="sticky top-0 z-40 bg-white/80 backdrop-blur-md border-b border-slate-200 mb-6">
        <div class="rainbow-strip"></div>
        <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-slate-900 text-white p-2 rounded-lg">
                    <i data-lucide="book-open" class="w-5 h-5"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-slate-800 leading-none">Gabriel's Log</h1>
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Homeschool Record</div>
                </div>
            </div>

            <div class="flex items-center gap-2">
                <!-- Desktop View Toggles -->
                <div id="nav-buttons" class="hidden md:flex bg-slate-100 p-1 rounded-lg">
                    <!-- Injected by JS -->
                </div>

                <div class="h-6 w-px bg-slate-200 mx-1 hidden md:block"></div>

                <button id="btn-pdf" class="hidden flex items-center gap-2 px-3 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 transition-colors shadow-sm text-sm font-medium">
                    <i data-lucide="file-down" class="w-4 h-4"></i>
                    <span class="hidden sm:inline">PDF Report</span>
                </button>
            </div>
        </div>
        
        <!-- Mobile Nav Tabs -->
        <div id="mobile-nav" class="md:hidden flex overflow-x-auto border-t border-slate-100 no-scrollbar">
            <!-- Injected by JS -->
        </div>
    </nav>

    <!-- Main Layout -->
    <main class="max-w-6xl mx-auto px-4">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
            
            <!-- LEFT COLUMN: Editor (Sticky on Desktop) -->
            <div id="editor-panel" class="lg:col-span-4 lg:sticky lg:top-24 space-y-4 transition-all duration-300">
                
                <!-- Date Controller Card -->
                <div class="pro-card p-4 flex items-center justify-between bg-white">
                    <button id="prev-date" class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-slate-50 text-slate-400 hover:text-indigo-600 transition-colors">
                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                    </button>
                    <div class="text-center">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Viewing Date</label>
                        <input type="date" id="date-input" class="bg-transparent border-none font-bold text-slate-800 text-lg text-center focus:ring-0 p-0 cursor-pointer w-full font-outfit">
                    </div>
                    <button id="next-date" class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-slate-50 text-slate-400 hover:text-indigo-600 transition-colors">
                        <i data-lucide="chevron-right" class="w-6 h-6"></i>
                    </button>
                </div>

                <!-- Input Form Card -->
                <div class="pro-card overflow-hidden">
                    <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                        <h2 class="font-bold text-slate-700 flex items-center gap-2" id="form-title">
                            <i data-lucide="pen-tool" class="w-4 h-4 text-indigo-500"></i>
                            New Entry
                        </h2>
                        <button id="cancel-edit-btn" class="hidden text-xs font-bold text-red-600 bg-red-50 px-2 py-1 rounded hover:bg-red-100">Cancel</button>
                    </div>

                    <form id="journal-form" class="p-5 space-y-4">
                        
                        <!-- Type Toggle -->
                        <div class="grid grid-cols-3 gap-2 p-1 bg-slate-100 rounded-xl">
                            <label class="cursor-pointer text-center">
                                <input type="radio" name="entryType" value="daily" class="peer hidden" checked>
                                <div class="py-2 rounded-lg text-xs font-bold text-slate-500 peer-checked:bg-white peer-checked:text-indigo-600 peer-checked:shadow-sm transition-all">Daily</div>
                            </label>
                            <label class="cursor-pointer text-center">
                                <input type="radio" name="entryType" value="weekly" class="peer hidden">
                                <div class="py-2 rounded-lg text-xs font-bold text-slate-500 peer-checked:bg-white peer-checked:text-indigo-600 peer-checked:shadow-sm transition-all">Weekly</div>
                            </label>
                            <label class="cursor-pointer text-center">
                                <input type="radio" name="entryType" value="unit" class="peer hidden">
                                <div class="py-2 rounded-lg text-xs font-bold text-slate-500 peer-checked:bg-white peer-checked:text-indigo-600 peer-checked:shadow-sm transition-all">Unit</div>
                            </label>
                        </div>

                        <!-- Subject & Category Grid -->
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs font-bold text-slate-400 uppercase mb-1 block">Subject</label>
                                <select id="input-subject" class="form-input">
                                    <option value="Math">Math</option>
                                    <option value="Language Arts">Language Arts</option>
                                    <option value="Science">Science</option>
                                    <option value="History">History</option>
                                    <option value="Geography">Geography</option>
                                    <option value="Art">Art</option>
                                    <option value="Music">Music</option>
                                    <option value="PE">PE</option>
                                    <option value="Reading">Reading</option>
                                    <option value="Technology">Technology</option>
                                    <option value="Life Skills">Life Skills</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-400 uppercase mb-1 block">Activity Type</label>
                                <input id="input-category" list="category-list" class="form-input" placeholder="Select..." value="Lesson">
                                <datalist id="category-list">
                                    <option value="Worksheet"></option>
                                    <option value="Online Lesson"></option>
                                    <option value="Book Work"></option>
                                    <option value="Hands-on Project"></option>
                                    <option value="Reading"></option>
                                    <option value="Writing"></option>
                                    <option value="Quiz / Test"></option>
                                    <option value="Documentary"></option>
                                    <option value="Field Trip"></option>
                                </datalist>
                            </div>
                        </div>

                        <!-- Unit (Optional) -->
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase mb-1 block">Unit / Module</label>
                            <input type="text" id="input-unit" class="form-input" placeholder="e.g. Unit 4: Solar System">
                        </div>

                        <!-- Main Topic -->
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase mb-1 block">What did Gabriel do?</label>
                            <textarea id="input-topic" class="form-input min-h-[80px] resize-none" placeholder="Description of the activity..." required></textarea>
                        </div>

                        <!-- Assignments -->
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase mb-1 block">Assignments / Pages</label>
                            <input type="text" id="input-assignments" class="form-input" placeholder="e.g. Workbook pg. 42-45">
                        </div>

                        <!-- Notes -->
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase mb-1 block">Observations / Notes</label>
                            <input type="text" id="input-notes" class="form-input" placeholder="e.g. Struggled with fractions, did great on focus">
                        </div>

                        <button type="submit" id="save-btn" class="w-full bg-slate-900 text-white font-bold py-3.5 rounded-xl shadow-lg hover:bg-slate-800 hover:scale-[1.01] active:scale-95 transition-all flex justify-center items-center gap-2 mt-2">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                            <span>Save Entry</span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- RIGHT COLUMN: The Log Feed -->
            <div id="view-container" class="lg:col-span-8 space-y-6 pb-20 transition-all duration-300">
                <!-- Content injected via JS -->
                <div class="flex flex-col items-center justify-center h-64 opacity-50">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-slate-800 mb-4"></div>
                    <p class="text-sm font-medium">Loading records...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Firebase Configuration -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // --- GLOBAL STATE ---
        const state = {
            user: null,
            entries: [],
            viewMode: 'daily', // 'daily', 'weekly', 'unit', 'all'
            date: new Date().toISOString().split('T')[0],
            loading: true,
            editingId: null,
            expandedSections: {} 
        };

        const { jsPDF } = window.jspdf;

        // --- FIREBASE INIT ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- AUTH & DATA ---
        async function initAuth() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        }

        initAuth();

        onAuthStateChanged(auth, (user) => {
            state.user = user;
            if (user) {
                // FIXED: Switch from 'users/{uid}/daily_journal' to 'public/data/daily_journal'
                // This ensures data persists even if the anonymous User ID rotates.
                const journalRef = collection(db, 'artifacts', appId, 'public', 'data', 'daily_journal');
                
                onSnapshot(journalRef, (snapshot) => {
                    const loaded = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    
                    // Complex Sort: Date DESC -> Order ASC -> CreatedAt DESC
                    loaded.sort((a, b) => {
                        const dateA = new Date(a.date);
                        const dateB = new Date(b.date);
                        if (dateA > dateB) return -1;
                        if (dateA < dateB) return 1;
                        
                        // Same date: Check order field
                        const orderA = a.order || 0;
                        const orderB = b.order || 0;
                        return orderA - orderB; 
                    });
                    
                    state.entries = loaded;
                    state.loading = false;
                    renderApp();
                    updateExportButton();
                }, (error) => {
                    console.error("Data fetch error:", error);
                    state.loading = false;
                    renderApp(); // Render empty state on error
                });
            } else {
                state.loading = false;
                renderApp();
            }
        });

        // --- HELPERS ---
        const formatDate = (str) => {
            const d = new Date(str + 'T12:00:00'); // Fix timezone offset issues
            return d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
        };

        const getSubjectConfig = (subj) => {
            const config = {
                'Math': { color: 'text-blue-600', bg: 'bg-blue-50', border: 'border-blue-100' },
                'Science': { color: 'text-emerald-600', bg: 'bg-emerald-50', border: 'border-emerald-100' },
                'Language Arts': { color: 'text-pink-600', bg: 'bg-pink-50', border: 'border-pink-100' },
                'History': { color: 'text-amber-600', bg: 'bg-amber-50', border: 'border-amber-100' },
                'Geography': { color: 'text-orange-600', bg: 'bg-orange-50', border: 'border-orange-100' },
                'Art': { color: 'text-purple-600', bg: 'bg-purple-50', border: 'border-purple-100' },
                'Reading': { color: 'text-teal-600', bg: 'bg-teal-50', border: 'border-teal-100' },
                'Technology': { color: 'text-cyan-600', bg: 'bg-cyan-50', border: 'border-cyan-100' },
                'PE': { color: 'text-red-600', bg: 'bg-red-50', border: 'border-red-100' },
                'Life Skills': { color: 'text-lime-600', bg: 'bg-lime-50', border: 'border-lime-100' }
            };
            return config[subj] || { color: 'text-slate-600', bg: 'bg-slate-50', border: 'border-slate-100' };
        };

        // --- DOM ACTIONS ---
        
        // Date Navigation
        document.getElementById('prev-date').addEventListener('click', () => changeDate(-1));
        document.getElementById('next-date').addEventListener('click', () => changeDate(1));
        const dateInput = document.getElementById('date-input');
        dateInput.value = state.date;
        dateInput.addEventListener('change', (e) => {
            state.date = e.target.value;
            renderApp();
        });

        function changeDate(days) {
            const d = new Date(state.date);
            d.setDate(d.getDate() + days);
            state.date = d.toISOString().split('T')[0];
            dateInput.value = state.date;
            renderApp();
        }

        // View Mode Handlers
        document.querySelectorAll('input[name="entryType"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                state.viewMode = e.target.value;
                renderApp();
            });
        });

        // Edit Entry Logic
        window.editEntry = (id) => {
            const entry = state.entries.find(e => e.id === id);
            if (!entry) return;

            state.editingId = id;
            
            // Populate Form
            document.getElementById('date-input').value = entry.date;
            state.date = entry.date; 
            
            const radio = document.querySelector(`input[name="entryType"][value="${entry.type || 'daily'}"]`);
            if(radio) radio.checked = true;

            document.getElementById('input-subject').value = entry.subject || 'Math';
            document.getElementById('input-category').value = entry.category || '';
            document.getElementById('input-unit').value = entry.unit || '';
            document.getElementById('input-topic').value = entry.topic || '';
            document.getElementById('input-assignments').value = entry.assignments || '';
            document.getElementById('input-notes').value = entry.notes || '';

            // Update UI
            document.getElementById('form-title').innerHTML = `<span class="text-indigo-600">Editing Entry</span>`;
            const saveBtn = document.getElementById('save-btn');
            saveBtn.innerHTML = `<span>Update Entry</span>`;
            saveBtn.classList.replace('bg-slate-900', 'bg-indigo-600');
            saveBtn.classList.replace('hover:bg-slate-800', 'hover:bg-indigo-700');
            
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
            
            // Scroll to form on mobile
            if(window.innerWidth < 1024) {
                document.getElementById('journal-form').scrollIntoView({ behavior: 'smooth' });
            }
            renderApp();
        };

        document.getElementById('cancel-edit-btn').addEventListener('click', resetForm);

        function resetForm() {
            state.editingId = null;
            document.getElementById('input-topic').value = '';
            document.getElementById('input-assignments').value = '';
            document.getElementById('input-notes').value = '';
            
            document.getElementById('form-title').innerHTML = `<i data-lucide="pen-tool" class="w-4 h-4 text-indigo-500"></i> New Entry`;
            const saveBtn = document.getElementById('save-btn');
            saveBtn.innerHTML = `<i data-lucide="plus" class="w-5 h-5"></i> <span>Save Entry</span>`;
            saveBtn.classList.replace('bg-indigo-600', 'bg-slate-900');
            saveBtn.classList.replace('hover:bg-indigo-700', 'hover:bg-slate-800');
            
            document.getElementById('cancel-edit-btn').classList.add('hidden');
            lucide.createIcons();
        }

        // Form Submit
        document.getElementById('journal-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!state.user) return;
            
            const entryType = document.querySelector('input[name="entryType"]:checked').value;
            const entryDate = document.getElementById('date-input').value;

            const data = {
                type: entryType,
                date: entryDate,
                subject: document.getElementById('input-subject').value,
                category: document.getElementById('input-category').value,
                unit: document.getElementById('input-unit').value,
                topic: document.getElementById('input-topic').value,
                assignments: document.getElementById('input-assignments').value,
                notes: document.getElementById('input-notes').value,
                updatedAt: serverTimestamp()
            };

            try {
                if (state.editingId) {
                    // Update: Public Path
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'daily_journal', state.editingId), data);
                    resetForm();
                } else {
                    data.createdAt = serverTimestamp();
                    data.order = Date.now(); 
                    // Add: Public Path
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'daily_journal'), data);
                    
                    // Clear main fields but keep subject/date for rapid entry
                    document.getElementById('input-topic').value = '';
                    document.getElementById('input-assignments').value = '';
                    document.getElementById('input-notes').value = '';
                }
            } catch(err) {
                console.error(err);
                alert("Error saving: " + err.message);
            }
        });

        // Drag and Drop Logic
        window.handleDragStart = (e, id) => {
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', id);
            e.currentTarget.classList.add('dragging');
        }

        window.handleDragEnd = (e) => {
            e.currentTarget.classList.remove('dragging');
            document.querySelectorAll('.drag-item').forEach(item => {
                item.classList.remove('drag-over');
            });
        }

        window.handleDragOver = (e) => {
            if (e.preventDefault) e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            e.currentTarget.classList.add('drag-over');
            return false;
        }

        window.handleDragLeave = (e) => {
            e.currentTarget.classList.remove('drag-over');
        }

        window.handleDrop = async (e, targetId) => {
            if (e.stopPropagation) e.stopPropagation();
            
            const sourceId = e.dataTransfer.getData('text/plain');
            if (sourceId === targetId) return false;

            const sourceEntry = state.entries.find(en => en.id === sourceId);
            const targetEntry = state.entries.find(en => en.id === targetId);

            if (sourceEntry && targetEntry) {
                // Swap order strategy
                const sOrder = sourceEntry.order || 0;
                const tOrder = targetEntry.order || 0;

                try {
                    // Update: Public Path
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'daily_journal', sourceId), { order: tOrder });
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'daily_journal', targetId), { order: sOrder });
                } catch(err) {
                    console.error("Reorder failed", err);
                }
            }
            return false;
        }

        // Delete Action
        window.deleteEntry = async (id) => {
            if(confirm('Are you sure you want to delete this record?')) {
                // Delete: Public Path
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'daily_journal', id));
            }
        };

        // View Switching
        window.setView = (mode) => {
            state.viewMode = mode;
            const radio = document.querySelector(`input[name="entryType"][value="${mode}"]`);
            if(radio) radio.checked = true;
            renderApp();
        };

        // --- PDF EXPORT ---
        const btnPdf = document.getElementById('btn-pdf');
        
        function updateExportButton() {
            if(state.entries.length > 0) btnPdf.classList.remove('hidden');
            else btnPdf.classList.add('hidden');
        }

        btnPdf.addEventListener('click', () => {
            if(state.entries.length === 0) return;

            const doc = new jsPDF();
            
            // Header
            doc.setFontSize(18);
            doc.setTextColor(40, 40, 40);
            doc.text(`Homeschool Log: Gabriel Mendoza`, 14, 20);
            
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(`Report Date: ${new Date().toLocaleDateString()}`, 14, 26);
            doc.text(`View: ${state.viewMode.toUpperCase()}`, 14, 31);

            // Filter data based on current view
            let dataToExport = [];
            if (state.viewMode === 'daily') {
                dataToExport = state.entries.filter(e => e.date === state.date);
            } else {
                dataToExport = state.entries; // Export all for history views
            }

            const tableData = dataToExport.map(e => [
                e.date,
                e.subject,
                e.category,
                e.topic,
                e.assignments || '-',
                e.notes || '-'
            ]);

            doc.autoTable({
                startY: 35,
                head: [['Date', 'Subject', 'Type', 'Activity / Topic', 'Assignments', 'Notes']],
                body: tableData,
                theme: 'grid',
                styles: { fontSize: 8, font: 'helvetica' },
                headStyles: { fillColor: [51, 65, 85] }
            });

            doc.save(`Gabriel_Log_${state.date}.pdf`);
        });


        // --- RENDER LOGIC ---
        function renderApp() {
            renderNav();
            const container = document.getElementById('view-container');
            const editorPanel = document.getElementById('editor-panel');
            
            if (state.loading) return;
            
            let filteredEntries = [];
            let title = "";
            let subTitle = "";

            // Dynamic Layout Logic
            if (state.viewMode === 'all') {
                editorPanel.classList.add('hidden');
                container.classList.remove('lg:col-span-8');
                container.classList.add('lg:col-span-12');
            } else {
                editorPanel.classList.remove('hidden');
                container.classList.add('lg:col-span-8');
                container.classList.remove('lg:col-span-12');
            }

            if (state.viewMode === 'daily') {
                filteredEntries = state.entries.filter(e => (!e.type || e.type === 'daily') && e.date === state.date);
                title = "Today's Activities";
                subTitle = formatDate(state.date);
            } else if (state.viewMode === 'weekly') {
                filteredEntries = state.entries.filter(e => e.type === 'weekly');
                title = "Weekly Summaries";
                subTitle = "High-level overview";
            } else if (state.viewMode === 'unit') {
                filteredEntries = state.entries.filter(e => e.type === 'unit');
                title = "Unit Progress";
                subTitle = "Module completion tracking";
            } else if (state.viewMode === 'all') {
                filteredEntries = state.entries;
                title = "Complete History";
                subTitle = `${state.entries.length} records found`;
            }

            // Header for Content Area
            let contentHTML = `
                <div class="flex items-end justify-between mb-4 pl-1">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">${title}</h2>
                        <div class="text-slate-500 font-medium text-sm">${subTitle}</div>
                    </div>
                    <div class="text-xs font-bold text-slate-300 uppercase tracking-widest">${filteredEntries.length} Items</div>
                </div>
            `;

            // EMPTY STATE
            if (filteredEntries.length === 0) {
                 contentHTML += `
                    <div class="pro-card p-10 text-center border-dashed border-2 border-slate-200 shadow-none bg-slate-50">
                        <div class="mx-auto w-12 h-12 bg-white rounded-full flex items-center justify-center mb-3 shadow-sm text-slate-300">
                            <i data-lucide="clipboard-list" class="w-6 h-6"></i>
                        </div>
                        <h3 class="text-base font-bold text-slate-600">No records found</h3>
                        <p class="text-sm text-slate-400 mt-1">Use the form on the left to add a new entry.</p>
                    </div>`;
            } else {
                contentHTML += `<div class="space-y-4">`;
                
                // Group by Subject if Daily, else flat list
                if (state.viewMode === 'daily') {
                    // Sort by order is already done in fetching
                    filteredEntries.forEach(entry => {
                        const style = getSubjectConfig(entry.subject);
                        contentHTML += `
                            <div class="drag-item pro-card p-0 flex flex-col md:flex-row overflow-hidden relative group cursor-grab active:cursor-grabbing"
                                 draggable="true"
                                 ondragstart="handleDragStart(event, '${entry.id}')"
                                 ondragend="handleDragEnd(event)"
                                 ondragover="handleDragOver(event)"
                                 ondragleave="handleDragLeave(event)"
                                 ondrop="handleDrop(event, '${entry.id}')"
                            >
                                <!-- Actions Overlay -->
                                <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1 z-10 bg-white/90 backdrop-blur rounded-lg shadow-sm p-1">
                                    <button onclick="editEntry('${entry.id}')" class="p-1.5 text-slate-400 hover:text-indigo-600 rounded-md hover:bg-indigo-50 transition-colors">
                                        <i data-lucide="pencil" class="w-4 h-4"></i>
                                    </button>
                                    <button onclick="deleteEntry('${entry.id}')" class="p-1.5 text-slate-400 hover:text-red-600 rounded-md hover:bg-red-50 transition-colors">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </div>

                                <!-- Left Color Strip -->
                                <div class="w-full md:w-2 ${style.bg.replace('50', '500')} shrink-0 h-2 md:h-auto"></div>

                                <!-- Main Content -->
                                <div class="flex-1 p-5">
                                    <div class="flex items-center gap-2 mb-1.5">
                                        <span class="px-2 py-0.5 rounded-md text-[10px] font-bold uppercase tracking-wider ${style.bg} ${style.color} border ${style.border}">
                                            ${entry.subject}
                                        </span>
                                        <span class="text-xs font-bold text-slate-400">â€¢</span>
                                        <span class="text-xs font-bold text-slate-500 uppercase tracking-wide">
                                            ${entry.category || 'Activity'}
                                        </span>
                                    </div>
                                    
                                    <h3 class="text-lg font-bold text-slate-800 leading-snug mb-2">
                                        ${entry.unit ? `<span class="text-slate-500 font-medium">${entry.unit}:</span> ` : ''}
                                        ${entry.topic}
                                    </h3>

                                    ${(entry.assignments || entry.notes) ? `
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3 pt-3 border-t border-slate-50">
                                            ${entry.assignments ? `
                                                <div class="flex items-start gap-2">
                                                    <div class="mt-0.5 text-amber-500"><i data-lucide="check-square" class="w-3.5 h-3.5"></i></div>
                                                    <div>
                                                        <div class="text-[10px] font-bold text-slate-400 uppercase">Assignment</div>
                                                        <div class="text-sm font-medium text-slate-700">${entry.assignments}</div>
                                                    </div>
                                                </div>
                                            ` : ''}
                                            ${entry.notes ? `
                                                <div class="flex items-start gap-2">
                                                    <div class="mt-0.5 text-slate-400"><i data-lucide="message-square" class="w-3.5 h-3.5"></i></div>
                                                    <div>
                                                        <div class="text-[10px] font-bold text-slate-400 uppercase">Notes</div>
                                                        <div class="text-sm font-medium text-slate-600 italic">"${entry.notes}"</div>
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    });
                } else {
                    // History List Style
                    filteredEntries.forEach(entry => {
                         const style = getSubjectConfig(entry.subject);
                         contentHTML += `
                            <div class="pro-card p-5 flex gap-4 items-start group relative">
                                <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity flex gap-2">
                                    <button onclick="editEntry('${entry.id}')" class="text-slate-300 hover:text-indigo-600"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                                    <button onclick="deleteEntry('${entry.id}')" class="text-slate-300 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                                <div class="hidden md:block w-16 text-center pt-1 shrink-0">
                                    <div class="text-[10px] font-bold text-slate-400 uppercase">${formatDate(entry.date).split(',')[0].substr(0,3)}</div>
                                    <div class="text-xl font-bold text-slate-700">${entry.date.split('-')[2]}</div>
                                </div>
                                <div>
                                    <div class="flex gap-2 mb-1">
                                        <span class="text-[10px] font-bold px-1.5 py-0.5 rounded bg-slate-100 text-slate-500 uppercase">${entry.type || 'daily'}</span>
                                        <span class="text-[10px] font-bold px-1.5 py-0.5 rounded ${style.bg} ${style.color} uppercase">${entry.subject}</span>
                                    </div>
                                    <div class="text-base font-bold text-slate-800">${entry.topic}</div>
                                    <div class="text-sm text-slate-500 mt-1 line-clamp-2">${entry.notes || entry.assignments || 'No details'}</div>
                                </div>
                            </div>
                         `;
                    });
                }
                contentHTML += `</div>`;
            }

            container.innerHTML = contentHTML;
            lucide.createIcons();
        }

        function renderNav() {
            // Count total items
            // const totalCount = state.entries.length;

            const views = [
                { id: 'daily', label: 'Daily', icon: 'layout-grid' },
                { id: 'weekly', label: 'Weekly', icon: 'calendar-range' },
                { id: 'unit', label: 'Unit Log', icon: 'folder-open' },
                { id: 'all', label: 'History', icon: 'history' }
            ];

            // Desktop Nav
            const navHTML = views.map(v => `
                <button onclick="setView('${v.id}')" 
                    class="flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-bold transition-all ${state.viewMode === v.id ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700 hover:bg-slate-200/50'}">
                    <i data-lucide="${v.icon}" class="w-4 h-4"></i>
                    ${v.label}
                </button>
            `).join('');
            document.getElementById('nav-buttons').innerHTML = navHTML;

            // Mobile Nav (Tabs)
            const mobileNavHTML = views.map(v => `
                <button onclick="setView('${v.id}')" class="flex-1 py-3 text-xs font-bold uppercase tracking-wide border-b-2 transition-colors ${state.viewMode === v.id ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-slate-400'}">
                    ${v.label}
                </button>
            `).join('');
            document.getElementById('mobile-nav').innerHTML = mobileNavHTML;
            
            lucide.createIcons();
        }

        // Initial Render
        renderApp();
    </script>
</body>
</html>